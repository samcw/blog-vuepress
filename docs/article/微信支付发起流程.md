---
title: 微信支付流程
category: Wechat
description: 这个函数会返回一个函数数组。表面上看，似乎每个函数都应该返自己的索引值，即位置 0 的函数 返回 0，位置 1 的函数返回 1，以此类推。但实际上，每个函数都返回 10。因为每个函数的作用域链中 都保存着 createFunctions()函数的活动对象，所以它们引用的都是同一个变量 i。当 createFunctions()函数返回后，变量 i 的值是 10，此时每个函数都引用着保存变量 i 的同一个变量 对象，所以在每个函数内部 i 的值都是 10。
time: 2020-03-10
---
# 微信支付发起流程

![小程序支付时序图](https://pay.weixin.qq.com/wiki/doc/api/img/wxa-7-2.jpg)

当所有的前期准备工作完成之后，一个完整的支付流程如上图所示。

### 图片术语解释：

1. 微信支付用户：即使用微信小程序的用户。
2. 微信小程序：即微信小程序。
3. 商户系统：为小程序提供响应服务，做数据处理，请求微信平台接口的服务器。
4. 微信后台：即微信给我们提供接口的服务器。

### 支付流程：

#### 1. 用户进入小程序：

1. 用户选好商品之后，提交订单。此时，小程序请求下单支付，我们的服务器响应。我们的服务器开始调用微信后台的登陆API。这个API的规范为：https://developers.weixin.qq.com/miniprogram/dev/api/open-api/login/wx.login.html。
2. 如果登陆接口成功返回数据，其中会包含`code`这个键。再调用`auth.code2Session`，它的规范为：https://developers.weixin.qq.com/miniprogram/dev/api-backend/open-api/login/auth.code2Session.html，获得这个用户的数据，我们根据这些数据，生成一个商户订单，商户订单的命名规范为：https://pay.weixin.qq.com/wiki/doc/api/wxa/wxa_api.php?chapter=4_2。
3. 此时，我们的服务器，根据这些信息，开始调用统一下单接口，这个接口的规范为：https://pay.weixin.qq.com/wiki/doc/api/wxa/wxa_api.php?chapter=9_1&index=1，其中有些请求的字段，需要经过一些处理，满足一些要求，具体的要求为：https://pay.weixin.qq.com/wiki/doc/api/wxa/wxa_api.php?chapter=4_3。
4. 如果统一下单接口调用成功，会返回数据，之后，需要再对这些信息进行处理，处理的规则，见下一步。处理之后，我们服务器，将信息传递给前端小程序，小程序给用户展示一个支付界面。

#### 2. 用户点击支付按钮

1. 用户点击支付按钮之后，我们的前端直接调用微信的支付接口，规则为：https://pay.weixin.qq.com/wiki/doc/api/wxa/wxa_api.php?chapter=7_7&index=3。这个规则，包含了上一步，最后一项的数据处理方法。
2. 支付接口调用成功后，返回的信息会告诉小程序，是否支付成功。我们依据对应的信息，给用户展示结果。
3. 我们在第一步，第3项的统一下单接口请求参数里，会设置一个字段`notify_url`，它是接收微信支付结果通知的回调地址，工作形式为：https://pay.weixin.qq.com/wiki/doc/api/jsapi.php?chapter=9_7&index=8。具体设置参考那一项的规范接口链接。我们服务器接到通知之后，就可以去更改数据库的订单状态了。如果，回调因为各种原因，没有收到消息，我们可以主动的调用订单查询接口，去查询订单状态，规则为：https://pay.weixin.qq.com/wiki/doc/api/wxa/wxa_api.php?chapter=9_2。

### 退款流程

1. 调用退款接口，规则为：https://pay.weixin.qq.com/wiki/doc/api/jsapi.php?chapter=9_4。退款操作，均需要设置证书，证书的设置规则为：https://pay.weixin.qq.com/wiki/doc/api/jsapi.php?chapter=4_3。
2. 查询退款接口，此接口不需要证书，具体规则为：https://pay.weixin.qq.com/wiki/doc/api/jsapi.php?chapter=9_5。

### 参考文档

1. 小程序开发者文档：https://pay.weixin.qq.com/wiki/doc/api/wxa/wxa_api.php?chapter=7_3&index=1#

